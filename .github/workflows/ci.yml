name: КРОК.Командировки

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  full-check:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: krok_test_db
          POSTGRES_USER: krokuser
          POSTGRES_PASSWORD: krokpassword
        ports:
          - 5432:5432
        # Healthcheck нужен для того, чтобы job стартовала, когда postgres реально готов
        options: >-
          --health-cmd="pg_isready -U krokuser"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DATABASE_URL: postgres://krokuser:krokpassword@localhost:5432/krok_test_db

    steps:
      - name: Клонирование репозитория
        uses: actions/checkout@v4

      - name: Проверка дублирующихся зависимостей (requirements.txt)
        run: |
          if [ -f requirements.txt ]; then
            sort requirements.txt | uniq -d | awk '{print "Дубликат: "$1}' && exit 1 || true
          fi

      - name: Установка Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Установка зависимостей проекта
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install mypy black pylint pytest pytest-cov pip-audit psycopg2-binary

      - name: Проверка типов (mypy)
        run: |
          mypy app.py --ignore-missing-imports --show-error-codes > mypy-report.txt
          if grep -q "error:" mypy-report.txt; then
            cat mypy-report.txt
            exit 1
          fi

      - name: Проверка форматирования (black)
        run: |
          black app.py --check

      - name: Анализ стиля кода (pylint)
        run: |
          pylint app.py --output-format=parseable > pylint-report.txt || true

      - name: Проверка безопасности зависимостей
        run: |
          pip-audit > pip-audit-log.txt
          if grep -q "Vulnerabilities found" pip-audit-log.txt; then
            cat pip-audit-log.txt
            exit 1
          fi

      - name: Инициализация тестовой базы PostgreSQL
        env:
          DATABASE_URL: postgres://krokuser:krokpassword@localhost:5432/krok_test_db
        run: |
          export DATABASE_URL=$DATABASE_URL
          python -c "from app import init_db; init_db()"
          echo "База данных инициирована"

      - name: Проверка запуска Flask (и подключения к PostgreSQL)
        env:
          DATABASE_URL: postgres://krokuser:krokpassword@localhost:5432/krok_test_db
          FLASK_APP: app.py
        run: |
          python -m flask --version
          timeout 20s python app.py &
          sleep 10
          nc -zv localhost 5000 || (echo "Flask не запустился или не подключен к PostgreSQL!" && exit 1)
          kill %1 || true

      - name: Запустить тесты (pytest) с покрытием
        run: |
          pytest --cov=. --cov-report=xml --cov-report=html > pytest-report.txt || exit 1

      - name: Сохранить артефакты проверок
        uses: actions/upload-artifact@v4
        with:
          name: Проверки и отчеты
          path: |
            mypy-report.txt
            pylint-report.txt
            pip-audit-log.txt
            htmlcov
            coverage.xml
            pytest-report.txt
